pipeline {
  agent {
    node {
      label 'nodejs'
    }
  }
  stages {
    stage('build and test') {
      steps {
        container('nodejs') {
          sh 'which docker'
          sh 'npm install'
          sh 'npm test' 
        }
      }
    }
    stage('Sonar Analysis') {
            steps {
                script {
                      container('nodejs') {
                        withSonarQubeEnv("ks-sonar") {
                            sh """${tool("sonar")}/bin/sonar-scanner \
                            -Dsonar.projectKey=react-app \
                            -Dsonar.sources=. \
                            -Dsonar.projectName=react-app \
                            -Dsonar.projectVersion=1.0 """
                        }
                       }
                        def qualitygate = waitForQualityGate()
                        if (qualitygate.status != "OK") {
                            error "Pipeline aborted due to quality gate coverage failure: ${qualitygate.status}"
                        }
                }
            }                                    
        }
  }
}
